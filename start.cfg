[gcode_macro START_PRINT]
description: Home, preheat, level, mesh, clean, then heat to final temps + purge line. Call from slicer start g-code.
variable_state: 'Prepare'

gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        {action_respond_info("Error: _global_var macro missing!")}
        M117 ERROR: GLOBAL VAR MISSING
        LCD_RED
        CANCEL_PRINT
    {% endif %}

    # ---- Inputs & defaults ----
    {% set base_mesh_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|default(60)|int %}
    {% set preheat        = printer['gcode_macro _global_var'].preheat_temp|default(140)|int %}

    # Use slicer BED if present; else current target; else base mesh temp
    {% set bed_target     = params.BED|default(printer.heater_bed.target|default(base_mesh_temp))|int %}

    {% set noz_target     = params.EXTRUDER|default(printer.extruder.target|default(200))|int %}
    {% set FILE_NAME      = printer.print_stats.filename|string %}
    {% set safe_z         = 6.0 %}

    # Mesh temperature is the HOTTEST of base mesh temp vs desired bed_target
    {% set mesh_temp      = [base_mesh_temp, bed_target]|max %}

    LCD_ORANGE
    BEEP
    CLEAR_PAUSE
    G90

    {% if state == 'Prepare' %}
        {action_respond_info("PREPARE!")}
        M117 PREPARE {FILE_NAME}

        # Soften blobs but avoid oozing
        M104 S{preheat}
        # Heat bed to mesh temperature (stable probing)
        M140 S{mesh_temp}

        {% if printer.toolhead.homed_axes|lower != "xyz" %}
            G4 P2000
            G28
        {% endif %}

        CHECK_FILAMENT_SENSOR

        {action_respond_info("WAIT FOR BED (mesh temp)")}
        M190 S{mesh_temp}

        # Level at mesh temp
        {% if printer.quad_gantry_level.applied|lower != 'true' %}
            QUAD_GANTRY_LEVEL
        {% endif %}

        Z_COMPARE_BUTTON_TO_CENTER

        G1 Z{safe_z} F6000
        BED_MESH_CLEAR
        BED_MESH_CALIBRATE ADAPTIVE=1
        G1 Z{safe_z} F6000

        # Clean nozzle at preheat temp
        M109 S{preheat}
        CLEAN_NOZZLE

        # Now go to final print temps
        {action_respond_info("HEAT TO PRINT TEMPS")}
        M104 S{noz_target}
        M140 S{bed_target}
        M190 S{bed_target}   ; wait for bed
        M109 S{noz_target}   ; wait for nozzle

        # Run purge line before slicer priming
        LINE_PURGE

        # Small lift to avoid scuffing as the slicer takes over
        G1 Z{safe_z} F600

        SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Start"'
        UPDATE_DELAYED_GCODE ID=print_start_wait DURATION=0.5

    {% elif state == 'Start' %}
        LCD_GREEN
        M117 {FILE_NAME}
        save_last_file
        {action_respond_info("START!")}
        # nothing else hereâ€”your slicer now continues with priming, skirt, or brim
    {% endif %}


[delayed_gcode print_start_wait]
gcode:
    {% if printer['gcode_macro START_PRINT'].state != 'Start' %}
        START_PRINT
    {% endif %}