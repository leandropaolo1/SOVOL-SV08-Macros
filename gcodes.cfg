[gcode_macro M109]
description: Sets and waits for the extruder to reach the target temperature within a tolerance range.
rename_existing: M99109
gcode:    
    {% set s = params.S|float %}    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1}   
    {% endif %}
    
[gcode_macro M190]
description: Sets and waits for the bed to reach the target temperature within a tolerance range.
rename_existing: M99190
gcode:    
    {% set s = params.S|float %}
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1}  
    {% endif %}

[gcode_macro M106]
description: Sets the speed for cooling fans, handling fan0, fan1, and fan3 differently.
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    {% if fan == 'fan3'%}
            SET_FAN_SPEED FAN={fan} SPEED={speed}
    {% else %}
        SET_FAN_SPEED FAN={'fan0'} SPEED={speed}
        SET_FAN_SPEED FAN={'fan1'} SPEED={speed}
    {% endif %}
    
[gcode_macro M107]
description: Turns off cooling fans, handling fan0, fan1, and fan3 differently.
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% if fan == 'fan3'%}
            SET_FAN_SPEED FAN={fan} SPEED=0
    {% else %}
        SET_FAN_SPEED FAN={'fan0'} SPEED=0
        SET_FAN_SPEED FAN={'fan1'} SPEED=0
    {% endif %}
    
[gcode_macro M600]
description: Initiates a filament change by pausing the print and setting the filament_change state.
gcode:
    LCD_CYAN #MOD
    PAUSE STATE=filament_change

[gcode_macro G34]
description: Manually triggers quad gantry leveling and moves to a safe position.
gcode:
    LCD_YELLOW # MOD LCD calibrate color
    M117 MANUAL QGL
    BED_MESH_CLEAR
    G4 P2000 # MOD Add pause for steppers
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
      G28
    {% else %}
      G28 Z
    {% endif %}
    QUAD_GANTRY_LEVEL 
    G4 P2000 # MOD Add pause for steppers
    G28 Z
    G0 X175 Y175 Z30 F3600
    M117 G34 FINISHED