[gcode_macro LOAD_FILAMENT]
description: Loads filament into the extruder by heating and extruding, with filament sensor check.
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        {action_respond_info("Error: _global_var macro missing!")}
        M117 LOAD ERROR: GLOBAL_VAR MISSING
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    LCD_PURPLE # MOD LCD Load/Unload color
    {action_respond_info("Starting filament load.")}
    M117 LOAD START
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp = printer.extruder.target|int %}
    {% if printer.print_stats.state != "printing" %}
        ; Direct sensor check
        {% if 'filament_switch_sensor filament_sensor' in printer %}
            SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
            G4 P2000
            QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
            {% set direct_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
            {action_respond_info("Direct sensor check: Detected: %s" % direct_detected)}
        {% else %}
            {% set direct_detected = True %}
        {% endif %}
        
        CHECK_FILAMENT_SENSOR CANCEL=False
        {% if not direct_detected %}
            {action_respond_info("Aborting filament load due to no filament (direct check).")}
            M117 LOAD ABORTED
            LCD_RED
            BEEP
            M117 INSERT FILAMENT TO RETRY
            G4 P5000 ; Wait 5s for user to insert filament
            ; Retry check
            {% if 'filament_switch_sensor filament_sensor' in printer %}
                SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
                G4 P2000
                QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
                {% set retry_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
                {action_respond_info("Retry sensor check: Detected: %s" % retry_detected)}
                {% if not retry_detected %}
                    {action_respond_info("No filament inserted, aborting.")}
                    M117 LOAD ABORTED
                    LCD_RED
                    BEEP
                {% else %}
                    {action_respond_info("Filament inserted, proceeding.")}
                {% endif %}
            {% else %}
                {% set retry_detected = True %}
            {% endif %}
        {% else %}
            {% set retry_detected = True %}
        {% endif %}
        
        {% if retry_detected %}
            {action_respond_info("Initial filament check passed, proceeding to heat.")}
            M117 HEAT START
            {% if printer.print_stats.state != "paused" %}
                M104 S{extruder_temp}
                M117 NOZZLE HEATING
                {action_respond_info("NOZZLE NOT HOT! Heating to %d°C." % extruder_temp)}
                M109 S{extruder_temp}
            {% else %}
                {% if printer.extruder.target == 0 %}
                    M104 S{extruder_temp}
                    M117 NOZZLE HEATING
                    {action_respond_info("NOZZLE NOT HOT! Heating to %d°C." % extruder_temp)}
                    M109 S{extruder_temp}
                {% else %}
                    M104 S{printer.extruder.target}
                    M117 NOZZLE HEATING
                    {action_respond_info("NOZZLE NOT HOT! Heating to %d°C." % printer.extruder.target)}
                    M109 S{printer.extruder.target}
                {% endif %}
            {% endif %}
            ; Pre-extrusion check
            {% if 'filament_switch_sensor filament_sensor' in printer %}
                SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
                G4 P2000
                QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
                {% set pre_extrude_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
                {action_respond_info("Pre-extrusion sensor check: Detected: %s" % pre_extrude_detected)}
            {% else %}
                {% set pre_extrude_detected = True %}
            {% endif %}
            CHECK_FILAMENT_SENSOR CANCEL=False
            {% if not pre_extrude_detected %}
                {action_respond_info("Aborting filament load due to no filament (pre-extrusion check).")}
                M117 LOAD ABORTED
                LCD_RED
                BEEP
            {% else %}
                {action_respond_info("Pre-extrusion filament check passed, starting extrusion.")}
                M117 EXTRUDING
                G91
                G1 E45 F300
                G1 E30 F150
                G90
                M400
                CHECK_FILAMENT_SENSOR CANCEL=False
                ; Post-extrusion check
                {% if 'filament_switch_sensor filament_sensor' in printer %}
                    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
                    G4 P2000
                    QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
                    {% set post_extrude_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
                    {action_respond_info("Post-extrusion sensor check: Detected: %s" % post_extrude_detected)}
                {% else %}
                    {% set post_extrude_detected = True %}
                {% endif %}
                {% if not post_extrude_detected %}
                    {action_respond_info("Filament lost during extrusion, aborting.")}
                    M117 LOAD FAILED
                    LCD_RED
                    BEEP
                {% else %}
                    {action_respond_info("Extrusion complete.")}
                    M117 EXTRUDE FINISH
                {% endif %}
            {% endif %}
            M400
            {% if current_target_temp == 0 or printer.print_stats.state != "paused" %}
                M104 S0
                {action_respond_info("Cooling extruder.")}
            {% endif %}
        {% endif %}
    {% else %}
        {action_respond_info("Cannot load filament: Printer is currently printing!")}
        M117 NO LOAD: PRINTING
        LCD_RED
    {% endif %}
    {action_respond_info("Filament load process")}
    M117 LOAD END
    {action_respond_info("Filament load")}
    BEEP # MOD acoustic end signal
    
[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament from the extruder by heating and retracting.
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        {action_respond_info("Error: _global_var macro missing!")}
        M117 ERROR UNLOAD
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    LCD_PURPLE # MOD LCD Load/Unload color
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 NOZZLE HEATING
            {action_respond_info("NOZZLE NOT HOT!")}
            {action_respond_info("NOZZLE HEATING")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 NOZZLE HEATING
                {action_respond_info("NOZZLE NOT HOT!")}
                {action_respond_info("NOZZLE HEATING")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 NOZZLE HEATING
                {action_respond_info("NOZZLE NOT HOT!")}
                {action_respond_info("NOZZLE HEATING")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 RETRACTING
        G91
        G1 E+25 F300
        G1 E-10 F1500
        G1 E-20 F600
        M400
        G4 P3000
        G1 E-50 F300 
        G90
        M400
        M117 RETRACT FINISH
        {action_respond_info("Retract filament")}
        BEEP # MOD acoustic unload finished signal
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("DON'T UNLOAD FILAMENT! PRINTING!")}
    {% endif %}
    BEEP # MOD acoustic end signal


[gcode_macro CHECK_FILAMENT_SENSOR]
description: Checks filament sensor status and returns detection state.
gcode:
    {% set cancel = True %}
    {% if params.CANCEL is defined and params.CANCEL|lower in ['0', 'false', 'no'] %}
        {% set cancel = False %}
    {% endif %}
    {action_respond_info("Checking filament sensor.")}
    M117 SENSOR CHECK
    {% if 'filament_switch_sensor filament_sensor' in printer %}
        ; Attempt 1
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
        G4 P1000 ; Reset sensor
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        G4 P2000 ; Wait 2s for sensor to settle
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        {% set sensor_detected_1 = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        {action_respond_info("Sensor check attempt 1: Detected: %s" % sensor_detected_1)}
        M117 SENSOR ATTEMPT 1 D{sensor_detected_1}
        
        ; Attempt 2
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
        G4 P1000
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        G4 P2000
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        {% set sensor_detected_2 = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        {action_respond_info("Sensor check attempt 2: Detected: %s" % sensor_detected_2)}
        M117 SENSOR ATTEMPT 2 D{sensor_detected_2}
        
        ; Final state
        {% set sensor_detected = sensor_detected_2 %}
        {% if sensor_detected_1 != sensor_detected_2 %}
            {action_respond_info("Inconsistent sensor readings, assuming no filament for safety.")}
            {% set sensor_detected = False %}
        {% endif %}
        
        {action_respond_info("Final sensor check. Detected: %s" % sensor_detected)}
        M117 SENSOR FINAL D{sensor_detected}
        {% if not sensor_detected %}
            {action_respond_info("No filament detected! Please insert filament.")}
            M117 NO FILAMENT DETECTED
            LCD_RED
            BEEP
            {% if cancel %}
                {action_respond_info("Cancelling print due to no filament.")}
                M117 CANCELING PRINT
                CANCEL_PRINT
            {% else %}
                {action_respond_info("Insert filament to continue.")}
                M117 INSERT FILAMENT
            {% endif %}
        {% else %}
            {action_respond_info("Filament detected, proceeding.")}
            M117 FILAMENT OK
        {% endif %}
    {% else %}
        {action_respond_info("No filament sensor configured, assuming filament present.")}
        M117 NO SENSOR
        {% set sensor_detected = True %}
    {% endif %}
