[gcode_macro CANCEL_PRINT]
description: Cancels a print job, retracts filament, parks the toolhead, and signals cancellation.
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        {action_respond_info("Error: _global_var missing!")}
        M117 ERROR: GLOBAL VAR MISSING
        LCD_RED
        CANCEL_PRINT_BASE
    {% endif %}
    {% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
    {% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
    {% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
    {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}

    CANCEL_PRINT_BASE
    {action_respond_info("Print cancel!")}
    M117 CANCEL PRINT!
    
    G91
    {% if printer['filament_switch_sensor filament_sensor'].enable == True and 
          printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp %}
            G1 E-{e_restract} F500
        {% else %}
            {action_respond_info("NOZZLE NOT HOT")}
        {% endif %}
    {% endif %}

    {% if (printer.gcode_move.position.z + 10) < z_lift_max %}
        G1 Z+10 F3000
    {% else %}
        G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X{x_park} Y{y_park} F9000

    TURN_OFF_HEATERS
    SET_FAN_SPEED FAN=fan0 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    SET_FAN_SPEED FAN=fan1 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    G4 P{printer['gcode_macro _global_var'].post_print_cool_time} # MOD Extra nozzle cooling after print
    _ALL_FAN_OFF
    LCD_RED # MOD LCD cancel color
    BEEP # MOD acoustic cancel signal
    G4 P500 # MOD Pause
    BEEP # MOD acoustic cancel signal
    G4 P500 # MOD Pause
    BEEP # MOD acoustic cancel signal
    G4 P500 # MOD Pause
    CLEAR_PAUSE
    M84 X Y Z E

    M117 CANCELED
    {action_respond_info("CANCEL PRINT SUCCESS!")}
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'



