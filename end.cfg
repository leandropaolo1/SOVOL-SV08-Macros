[gcode_macro END_PRINT]
description: Finalizes a print job by retracting filament, parking the toolhead, and turning off heaters and fans.
variable_state: 'normal'
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        {action_respond_info("Error: _global_var macro missing!")}
        M117 ERROR: GLOBAL VAR MISSING
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}

    M400
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0  
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

    M117 PRINT FINISHED!
    G91
    {% if printer['filament_switch_sensor filament_sensor'].enable == True and
          printer['filament_switch_sensor filament_sensor'].filament_detected == True
    %}
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp
        %}
            G1 E-2 F2700
            G1 E-2 Z0.2 F2400
        {% endif %}
    {% endif %}

    {% if (printer.gcode_move.position.z + 10) < z_max %}
        G1 Z+10 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X0 Y360 F9000

    TURN_OFF_HEATERS
    SET_FAN_SPEED FAN=fan0 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    SET_FAN_SPEED FAN=fan1 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    G4 P{printer['gcode_macro _global_var'].post_print_cool_time} # MOD Extra nozzle cooling after print
    _ALL_FAN_OFF
    M84 X Y Z E  

    M220 S100
    M221 S100

    LCD_DEFAULT # MOD LCD Print finished - return to default
    BEEP # MOD acoustic end signal
    CLEAR_PAUSE
    PRINT_END

    {action_respond_info("PRINT FINISHED!")}
